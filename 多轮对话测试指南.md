# 多轮对话测试场景

## 测试前准备

1. 确保开发服务器正在运行：`npm run dev`
2. 确保数据库已初始化
3. 确保 GEMINI_API_KEY 环境变量已设置
4. 如需代理，确保代理服务已启动

## 测试场景

### 测试 1：基础多轮对话（数学计算）

**目的**：验证 AI 能记住之前提到的数字

1. **第一轮**
   - 输入：`我有 2 只狗在家里`
   - 预期：AI 回复确认信息

2. **第二轮**
   - 输入：`我家里有多少只爪子？`
   - 预期：AI 回答 `8 只爪子`（2只狗 × 4只爪子）
   - ✅ 如果 AI 正确回答，说明记住了"2只狗"

3. **第三轮**
   - 输入：`如果再来 1 只猫呢？`
   - 预期：AI 回答 `12 只爪子`（2只狗 + 1只猫 = 3只动物 × 4只爪子）
   - ✅ 如果正确，说明多轮上下文保持良好

### 测试 2：代码生成连续对话

**目的**：验证 AI 能理解代码修改请求

1. **第一轮**
   - 输入：`写一个 Python 函数计算两个数的和`
   - 预期：AI 提供 Python 代码

2. **第二轮**
   - 输入：`改成计算三个数的和`
   - 预期：AI 修改之前的函数
   - ✅ 如果 AI 知道要修改哪个函数，说明记住了上下文

3. **第三轮**
   - 输入：`添加参数验证`
   - 预期：AI 在之前的函数基础上添加验证逻辑
   - ✅ 验证上下文持续性

### 测试 3：语言切换

**目的**：验证 AI 能记住要转换的内容

1. **第一轮**
   - 输入：`写一个斐波那契函数，用 Python`
   - 预期：AI 提供 Python 版本

2. **第二轮**
   - 输入：`改成 JavaScript`
   - 预期：AI 提供相同逻辑的 JavaScript 版本
   - ✅ 验证 AI 记住了要转换什么

3. **第三轮**
   - 输入：`再改成 TypeScript，并添加类型注解`
   - 预期：AI 提供 TypeScript 版本
   - ✅ 验证连续转换能力

### 测试 4：故事接龙

**目的**：验证长上下文记忆

1. **第一轮**
   - 输入：`讲一个关于小猫冒险的故事，开头 3 句话`
   - 预期：AI 开始讲故事

2. **第二轮**
   - 输入：`继续，接下来发生了什么？`
   - 预期：AI 接着之前的故事继续
   - ✅ 验证情节连贯性

3. **第三轮**
   - 输入：`小猫找到回家的路了吗？`
   - 预期：AI 基于前面的情节回答
   - ✅ 验证对完整故事的理解

### 测试 5：角色扮演

**目的**：验证角色记忆

1. **第一轮**
   - 输入：`你现在是一个 Python 专家，只回答 Python 相关问题`
   - 预期：AI 确认角色

2. **第二轮**
   - 输入：`什么是装饰器？`
   - 预期：AI 用 Python 专家的口吻回答
   - ✅ 验证角色保持

3. **第三轮**
   - 输入：`给我举个例子`
   - 预期：AI 提供 Python 装饰器的例子
   - ✅ 验证角色和主题都保持

## 如何查看调试信息

### 浏览器控制台（前端）

打开浏览器开发者工具 (F12)，在 Console 中查看：

```
发送多轮对话，消息数量: 3
对话历史: ['user: 我有 2 只狗在家里...', 'assistant: 太好了！...', 'user: 我家里有多少只爪子？...']
```

### Node 终端（后端）

查看运行 `npm run dev` 的终端窗口：

```
接收到请求，模型: g2.5flash
消息数量: 3
完整对话历史: ['user: 我有 2 只狗在家里...', 'assistant: 太好了！...', 'user: 我家里有多少只爪子？...']
开始调用 Gemini API (多轮对话模式)...
✓ 流式响应完成
```

## 常见问题排查

### AI 没有记住之前的对话

**检查点：**
1. 打开浏览器控制台，查看"消息数量"是否 > 1
2. 查看"对话历史"是否包含之前的消息
3. 确认没有在对话过程中刷新页面或切换聊天

**解决方法：**
- 如果消息数量是 1，说明历史没有正确传递
- 检查 `messageList` 状态是否正确更新

### 请求失败或超时

**检查点：**
1. 后端日志是否显示"网络连接失败"
2. 代理是否正常运行（如果需要）
3. GEMINI_API_KEY 是否有效

**解决方法：**
- 检查代理设置：`echo %HTTP_PROXY%` 和 `echo %HTTPS_PROXY%`
- 验证 API key：在 Google AI Studio 检查
- 查看防火墙设置

### 切换聊天后上下文混乱

**这是正常行为**：
- 每个聊天会话有独立的上下文
- `chatIdRef` 切换时会重置
- 确保选择正确的聊天会话

## 成功标志

✅ **多轮对话成功**的标志：
1. AI 能回答需要之前上下文的问题
2. 日志显示消息数量递增（1 → 3 → 5 → ...）
3. 对话历史包含完整的往来记录
4. 没有出现"我不知道你在说什么"的情况

## 性能基准

- **首轮响应**：通常 1-3 秒
- **后续响应**：随历史增长略有延迟
- **建议对话轮数**：< 20 轮（避免 token 过多）
- **每轮最佳字数**：< 500 字
